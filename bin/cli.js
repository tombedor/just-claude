#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');
const { generateSkills, cleanSkills, listSkills } = require('../lib/generator.js');
const { install: installHooks } = require('../scripts/postinstall.js');

const COMMANDS = {
  init: 'Install hooks and generate skills',
  status: 'Show justfile and skill status',
  list: 'List all generated skills',
  clean: 'Remove all generated skills',
  help: 'Show this help message'
};

/**
 * Show help message
 */
function showHelp() {
  console.log('just-claude - Expose justfile recipes as Claude Code skills\n');
  console.log('Usage: just-claude <command>\n');
  console.log('Commands:');
  for (const [cmd, desc] of Object.entries(COMMANDS)) {
    console.log(`  ${cmd.padEnd(12)} ${desc}`);
  }
}

/**
 * Ensure .gitignore has the generated skills entry
 */
function ensureGitignore(projectRoot, mode = 'prompt') {
  const gitignorePath = path.join(projectRoot, '.gitignore');
  const entry = '.claude/skills/just-*/';

  let contents = '';
  let exists = false;

  if (fs.existsSync(gitignorePath)) {
    contents = fs.readFileSync(gitignorePath, 'utf-8');
    exists = true;

    const already = contents.split('\n').some(line => line.trim() === entry);
    if (already) {
      return Promise.resolve('already-present');
    }
  }

  if (mode === 'skip') {
    return Promise.resolve('skipped');
  }

  if (mode === 'prompt') {
    // Non-interactive environments: skip silently
    if (!process.stdin.isTTY || !process.stdout.isTTY) {
      return Promise.resolve('skipped-noninteractive');
    }

    const readline = require('readline');
    const rl = readline.createInterface({
      input: process.stdin,
      output: process.stdout
    });

    const question = (q) => new Promise(resolve => rl.question(q, resolve));

    return question('Add ".claude/skills/just-*/" to .gitignore? (Y/n) ').then(answer => {
      rl.close();
      const yes = answer.trim().toLowerCase();
      if (yes === 'n' || yes === 'no') {
        return 'skipped';
      }

      const newContents = contents
        ? contents.trimEnd() + '\n' + entry + '\n'
        : entry + '\n';
      fs.writeFileSync(gitignorePath, newContents, 'utf-8');
      console.log('just-claude: Added .claude/skills/just-*/ to .gitignore');
      return 'added';
    });
  }

  // Force add
  const newContents = contents
    ? contents.trimEnd() + '\n' + entry + '\n'
    : entry + '\n';
  fs.writeFileSync(gitignorePath, newContents, 'utf-8');
  console.log('just-claude: Added .claude/skills/just-*/ to .gitignore');
  return Promise.resolve('added');
}

/**
 * Check if just command is available
 */
function isJustAvailable() {
  try {
    execSync('command -v just', { stdio: 'ignore' });
    return true;
  } catch {
    return false;
  }
}

/**
 * Get justfile JSON
 */
function getJustfileJson(projectRoot) {
  try {
    const output = execSync('just --dump --dump-format json', {
      cwd: projectRoot,
      encoding: 'utf-8',
      stdio: ['ignore', 'pipe', 'ignore']
    });
    return JSON.parse(output);
  } catch {
    return null;
  }
}

/**
 * Show status command
 */
function statusCommand(projectRoot) {
  console.log('just-claude status\n');

  // Check if just is installed
  const justAvailable = isJustAvailable();
  console.log(`just command: ${justAvailable ? '✓ available' : '✗ not found'}`);

  if (!justAvailable) {
    console.log('\nInstall just from: https://github.com/casey/just');
    return;
  }

  // Check if justfile exists
  const justfileData = getJustfileJson(projectRoot);
  console.log(`justfile: ${justfileData ? '✓ found' : '✗ not found'}`);

  if (!justfileData) {
    return;
  }

  // Count recipes
  const { extractRecipes } = require('../lib/generator.js');
  const recipes = extractRecipes(justfileData);
  console.log(`public recipes: ${recipes.length}`);

  // Count generated skills
  const skillsDir = path.join(projectRoot, '.claude', 'skills');
  let skillCount = 0;

  if (fs.existsSync(skillsDir)) {
    const entries = fs.readdirSync(skillsDir, { withFileTypes: true });
    for (const entry of entries) {
      if (entry.isDirectory() && entry.name.startsWith('just-')) {
        const skillFile = path.join(skillsDir, entry.name, 'SKILL.md');
        if (fs.existsSync(skillFile)) {
          const content = fs.readFileSync(skillFile, 'utf-8');
          if (content.includes('<!-- Generated by just-claude')) {
            skillCount++;
          }
        }
      }
    }
  }

  console.log(`generated skills: ${skillCount}`);

  // Check hook configuration
  const settingsFile = path.join(projectRoot, '.claude', 'settings.json');
  let hookConfigured = false;

  if (fs.existsSync(settingsFile)) {
    try {
      const settings = JSON.parse(fs.readFileSync(settingsFile, 'utf-8'));
      const sessionStartHooks = settings?.hooks?.SessionStart;
      if (Array.isArray(sessionStartHooks)) {
        hookConfigured = sessionStartHooks.some(entry =>
          entry.hooks &&
          entry.hooks.some(h => h.command && h.command.includes('detect-justfile.sh'))
        );
      }
    } catch {
      // Ignore parse errors
    }
  }

  console.log(`hook configured: ${hookConfigured ? '✓ yes' : '✗ no'}`);
}

/**
 * Init command (install hooks + generate skills)
 */
async function initCommand(projectRoot, options = {}) {
  console.log('just-claude init\n');

  // Ensure hooks/settings are installed for this project
  installHooks(projectRoot);

  // Handle gitignore preference
  const gitignoreMode = options.gitIgnore === true
    ? 'force'
    : options.gitIgnore === false
      ? 'skip'
      : 'prompt';

  await ensureGitignore(projectRoot, gitignoreMode);

  const justAvailable = isJustAvailable();
  if (!justAvailable) {
    console.error('Error: just command not found');
    process.exit(1);
  }

  const justfileData = getJustfileJson(projectRoot);
  if (!justfileData) {
    console.error('Error: No justfile found');
    process.exit(1);
  }

  // Clean existing skills
  console.log('Cleaning existing skills...');
  cleanSkills(projectRoot);

  // Generate new skills
  console.log('Generating skills...');
  generateSkills(projectRoot, justfileData);

  console.log('\nInit complete!');
}

/**
 * Main CLI entry point
 */
function main() {
  const args = process.argv.slice(2);
  const command = args[0] || 'help';
  const commandArgs = args.slice(1);
  const projectRoot = process.cwd();

  switch (command) {
    case 'init':
      {
        const options = {
          gitIgnore: commandArgs.includes('--git-ignore') || commandArgs.includes('-i')
            ? true
            : commandArgs.includes('--no-git-ignore')
              ? false
              : undefined
        };
        initCommand(projectRoot, options).catch(err => {
          console.error('just-claude: init error:', err.message || err);
          process.exit(1);
        });
      }
      break;

    case 'status':
      statusCommand(projectRoot);
      break;

    case 'list':
      listSkills(projectRoot);
      break;

    case 'clean':
      cleanSkills(projectRoot);
      break;

    case 'help':
    case '--help':
    case '-h':
      showHelp();
      break;

    default:
      console.error(`Unknown command: ${command}\n`);
      showHelp();
      process.exit(1);
  }
}

main();
