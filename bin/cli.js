#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');
const { generateSkills, cleanSkills, listSkills } = require('../lib/generator.js');

const COMMANDS = {
  status: 'Show justfile and skill status',
  list: 'List all generated skills',
  regenerate: 'Regenerate skills from justfile',
  clean: 'Remove all generated skills',
  help: 'Show this help message'
};

/**
 * Show help message
 */
function showHelp() {
  console.log('just-claude - Expose justfile recipes as Claude Code skills\n');
  console.log('Usage: npx just-claude <command>\n');
  console.log('Commands:');
  for (const [cmd, desc] of Object.entries(COMMANDS)) {
    console.log(`  ${cmd.padEnd(12)} ${desc}`);
  }
}

/**
 * Check if just command is available
 */
function isJustAvailable() {
  try {
    execSync('command -v just', { stdio: 'ignore' });
    return true;
  } catch {
    return false;
  }
}

/**
 * Get justfile JSON
 */
function getJustfileJson(projectRoot) {
  try {
    const output = execSync('just --dump --dump-format json', {
      cwd: projectRoot,
      encoding: 'utf-8',
      stdio: ['ignore', 'pipe', 'ignore']
    });
    return JSON.parse(output);
  } catch {
    return null;
  }
}

/**
 * Show status command
 */
function statusCommand(projectRoot) {
  console.log('just-claude status\n');

  // Check if just is installed
  const justAvailable = isJustAvailable();
  console.log(`just command: ${justAvailable ? '✓ available' : '✗ not found'}`);

  if (!justAvailable) {
    console.log('\nInstall just from: https://github.com/casey/just');
    return;
  }

  // Check if justfile exists
  const justfileData = getJustfileJson(projectRoot);
  console.log(`justfile: ${justfileData ? '✓ found' : '✗ not found'}`);

  if (!justfileData) {
    return;
  }

  // Count recipes
  const { extractRecipes } = require('../lib/generator.js');
  const recipes = extractRecipes(justfileData);
  console.log(`public recipes: ${recipes.length}`);

  // Count generated skills
  const skillsDir = path.join(projectRoot, '.claude', 'skills');
  let skillCount = 0;

  if (fs.existsSync(skillsDir)) {
    const entries = fs.readdirSync(skillsDir, { withFileTypes: true });
    for (const entry of entries) {
      if (entry.isDirectory() && entry.name.startsWith('just-')) {
        const skillFile = path.join(skillsDir, entry.name, 'SKILL.md');
        if (fs.existsSync(skillFile)) {
          const content = fs.readFileSync(skillFile, 'utf-8');
          if (content.includes('<!-- Generated by just-claude')) {
            skillCount++;
          }
        }
      }
    }
  }

  console.log(`generated skills: ${skillCount}`);

  // Check hook configuration
  const settingsFile = path.join(projectRoot, '.claude', 'settings.json');
  let hookConfigured = false;

  if (fs.existsSync(settingsFile)) {
    try {
      const settings = JSON.parse(fs.readFileSync(settingsFile, 'utf-8'));
      if (Array.isArray(settings.hooks)) {
        hookConfigured = settings.hooks.some(hook =>
          hook.type === 'SessionStart' &&
          hook.hooks &&
          hook.hooks.some(h => h.command && h.command.includes('detect-justfile.sh'))
        );
      }
    } catch {
      // Ignore parse errors
    }
  }

  console.log(`hook configured: ${hookConfigured ? '✓ yes' : '✗ no'}`);
}

/**
 * Regenerate command
 */
function regenerateCommand(projectRoot) {
  const justAvailable = isJustAvailable();
  if (!justAvailable) {
    console.error('Error: just command not found');
    process.exit(1);
  }

  const justfileData = getJustfileJson(projectRoot);
  if (!justfileData) {
    console.error('Error: No justfile found');
    process.exit(1);
  }

  // Clean existing skills
  console.log('Cleaning existing skills...');
  cleanSkills(projectRoot);

  // Generate new skills
  console.log('Generating skills...');
  generateSkills(projectRoot, justfileData);

  console.log('\nRegeneration complete!');
}

/**
 * Main CLI entry point
 */
function main() {
  const args = process.argv.slice(2);
  const command = args[0] || 'help';
  const projectRoot = process.cwd();

  switch (command) {
    case 'status':
      statusCommand(projectRoot);
      break;

    case 'list':
      listSkills(projectRoot);
      break;

    case 'regenerate':
      regenerateCommand(projectRoot);
      break;

    case 'clean':
      cleanSkills(projectRoot);
      break;

    case 'help':
    case '--help':
    case '-h':
      showHelp();
      break;

    default:
      console.error(`Unknown command: ${command}\n`);
      showHelp();
      process.exit(1);
  }
}

main();
